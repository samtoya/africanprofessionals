
function RainyDay(b,a){if(this===window){return new RainyDay(b)}this.img=b.image;var d={opacity:1,blur:10,crop:[0,0,this.img.naturalWidth,this.img.naturalHeight],enableSizeChange:true,parentElement:document.getElementsByTagName("body")[0],fps:30,fillStyle:"#8ED6FF",enableCollisions:true,gravityThreshold:3,gravityAngle:Math.PI/2,gravityAngleVariance:0,reflectionScaledownFactor:5,reflectionDropMappingWidth:200,reflectionDropMappingHeight:200,width:this.img.clientWidth,height:this.img.clientHeight,position:"absolute",top:0,left:0};for(var c in d){if(typeof b[c]==="undefined"){b[c]=d[c]}}this.options=b;this.drops=[];this.canvas=a||this.prepareCanvas();this.prepareBackground(this.canvas.width,this.canvas.height);this.prepareGlass();this.reflection=this.REFLECTION_MINIATURE;this.trail=this.TRAIL_DROPS;this.gravity=this.GRAVITY_NON_LINEAR;this.collision=this.COLLISION_SIMPLE;this.setRequestAnimFrame()}RainyDay.prototype.prepareCanvas=function(){var a=document.createElement("canvas");a.style.position=this.options.position;a.style.top=this.options.top;a.style.left=this.options.left;a.width=this.options.width;a.height=this.options.height;this.options.parentElement.appendChild(a);if(this.enableSizeChange){this.setResizeHandler()}return a};RainyDay.prototype.setResizeHandler=function(){if(window.onresize!==null){window.setInterval(this.checkSize.bind(this),100)}else{window.onresize=this.checkSize.bind(this);window.onorientationchange=this.checkSize.bind(this)}};RainyDay.prototype.checkSize=function(){var h=this.img.clientWidth;var c=this.img.clientHeight;var b=this.img.offsetLeft;var f=this.img.offsetTop;var a=this.canvas.width;var e=this.canvas.height;var g=this.canvas.offsetLeft;var d=this.canvas.offsetTop;if(a!==h||e!==c){this.canvas.width=this.canvas.width;this.canvas.height=this.canvas.height;this.prepareBackground(this.canvas.width,this.canvas.height);this.glass.width=this.canvas.width;this.glass.height=this.canvas.height;this.prepareReflections()}if(g!==b||d!==f){this.canvas.offsetLeft=b;this.canvas.offsetTop=f}};RainyDay.prototype.animateDrops=function(){if(this.addDropCallback){this.addDropCallback()}var c=this.drops.slice();var a=[];for(var b=0;b<c.length;++b){if(c[b].animate()){a.push(c[b])}}this.drops=a;window.requestAnimFrame(this.animateDrops.bind(this))};RainyDay.prototype.setRequestAnimFrame=function(){var a=this.options.fps;window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(b){window.setTimeout(b,1000/a)}})()};RainyDay.prototype.prepareReflections=function(){this.reflected=document.createElement("canvas");this.reflected.width=this.canvas.width/this.options.reflectionScaledownFactor;this.reflected.height=this.canvas.height/this.options.reflectionScaledownFactor;var a=this.reflected.getContext("2d");a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.reflected.width,this.reflected.height)};RainyDay.prototype.prepareGlass=function(){this.glass=document.createElement("canvas");this.glass.width=this.canvas.width;this.glass.height=this.canvas.height;this.context=this.glass.getContext("2d")};RainyDay.prototype.rain=function(b,f){if(this.reflection!==this.REFLECTION_NONE){this.prepareReflections()}this.animateDrops();this.presets=b;this.PRIVATE_GRAVITY_FORCE_FACTOR_Y=(this.options.fps*0.001)/25;this.PRIVATE_GRAVITY_FORCE_FACTOR_X=((Math.PI/2)-this.options.gravityAngle)*(this.options.fps*0.001)/50;if(this.options.enableCollisions){var a=0;for(var d=0;d<b.length;d++){if(b[d][0]+b[d][1]>a){a=Math.floor(b[d][0]+b[d][1])}}if(a>0){var c=Math.ceil(this.canvas.width/a);var e=Math.ceil(this.canvas.height/a);this.matrix=new CollisionMatrix(c,e,a)}else{this.options.enableCollisions=false}}for(var d=0;d<b.length;d++){if(!b[d][3]){b[d][3]=-1}}var g=0;this.addDropCallback=function(){var l=new Date().getTime();if(l-g<f){return}g=l;var j=this.canvas.getContext("2d");j.clearRect(0,0,this.canvas.width,this.canvas.height);j.drawImage(this.background,0,0,this.canvas.width,this.canvas.height);var k;for(var h=0;h<b.length;h++){if(b[h][2]>1||b[h][3]===-1){if(b[h][3]!==0){b[h][3]--;for(var m=0;m<b[h][2];++m){this.putDrop(new Drop(this,Math.random()*this.canvas.width,Math.random()*this.canvas.height,b[h][0],b[h][1]))}}}else{if(Math.random()<b[h][2]){k=b[h];break}}}if(k){this.putDrop(new Drop(this,Math.random()*this.canvas.width,Math.random()*this.canvas.height,k[0],k[1]))}j.save();j.globalAlpha=this.opacity;j.drawImage(this.glass,0,0,this.canvas.width,this.canvas.height);j.restore()}.bind(this)};RainyDay.prototype.putDrop=function(a){a.draw();if(this.gravity&&a.r>this.options.gravityThreshold){if(this.options.enableCollisions){this.matrix.update(a)}this.drops.push(a)}};RainyDay.prototype.clearDrop=function(b,d){var a=b.clear(d);if(a){var c=this.drops.indexOf(b);if(c>=0){this.drops.splice(c,1)}}return a};function Drop(e,d,c,a,b){this.x=Math.floor(d);this.y=Math.floor(c);this.r=(Math.random()*b)+a;this.rainyday=e;this.context=e.context;this.reflection=e.reflected}Drop.prototype.draw=function(){this.context.save();this.context.beginPath();var b=this.r;this.r=0.95*this.r;if(this.r<3){this.context.arc(this.x,this.y,this.r,0,Math.PI*2,true);this.context.closePath()}else{if(this.colliding||this.yspeed>2){if(this.colliding){var a=this.colliding;this.r=1.001*(this.r>a.r?this.r:a.r);this.x+=(a.x-this.x);this.colliding=null}var c=1+0.1*this.yspeed;this.context.moveTo(this.x-this.r/c,this.y);this.context.bezierCurveTo(this.x-this.r,this.y-this.r*2,this.x+this.r,this.y-this.r*2,this.x+this.r/c,this.y);this.context.bezierCurveTo(this.x+this.r,this.y+c*this.r,this.x-this.r,this.y+c*this.r,this.x-this.r/c,this.y)}else{this.context.arc(this.x,this.y,this.r*0.9,0,Math.PI*2,true);this.context.closePath()}}this.context.clip();this.r=b;if(this.rainyday.reflection){this.rainyday.reflection(this)}this.context.restore()};Drop.prototype.clear=function(a){this.context.clearRect(this.x-this.r-1,this.y-this.r-2,2*this.r+2,2*this.r+2);if(a){this.terminate=true;return true}if((this.y-this.r>this.rainyday.h)||(this.x-this.r>this.rainyday.w)||(this.x+this.r<0)){return true}return false};Drop.prototype.animate=function(){if(this.terminate){return false}var b=this.rainyday.gravity(this);if(!b&&this.rainyday.trail){this.rainyday.trail(this)}if(this.rainyday.options.enableCollisions){var a=this.rainyday.matrix.update(this,b);if(a){this.rainyday.collision(this,a)}}return !b||this.terminate};RainyDay.prototype.TRAIL_NONE=function(){};RainyDay.prototype.TRAIL_DROPS=function(a){if(!a.trailY||a.y-a.trailY>=Math.random()*100*a.r){a.trailY=a.y;this.putDrop(new Drop(this,a.x+(Math.random()*2-1)*Math.random(),a.y-a.r-5,Math.ceil(a.r/5),0))}};RainyDay.prototype.TRAIL_SMUDGE=function(b){var c=b.y-b.r-3;var a=b.x-b.r/2+(Math.random()*2);if(c<0||a<0){return}this.context.drawImage(this.clearbackground,a,c,b.r,2,a,c,b.r,2)};RainyDay.prototype.GRAVITY_NONE=function(){return true};RainyDay.prototype.GRAVITY_LINEAR=function(a){if(this.clearDrop(a)){return true}if(a.yspeed){a.yspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r);a.xspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r)}else{a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}a.y+=a.yspeed;a.draw();return false};RainyDay.prototype.GRAVITY_NON_LINEAR=function(a){if(this.clearDrop(a)){return true}if(a.collided){a.collided=false;a.seed=Math.floor(a.r*Math.random()*this.options.fps);a.skipping=false;a.slowing=false}else{if(!a.seed||a.seed<0){a.seed=Math.floor(a.r*Math.random()*this.options.fps);a.skipping=a.skipping===false?true:false;a.slowing=true}}a.seed--;if(a.yspeed){if(a.slowing){a.yspeed/=1.1;a.xspeed/=1.1;if(a.yspeed<this.PRIVATE_GRAVITY_FORCE_FACTOR_Y){a.slowing=false}}else{if(a.skipping){a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}else{a.yspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r);a.xspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r)}}}else{a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}if(this.options.gravityAngleVariance!==0){a.xspeed+=((Math.random()*2-1)*a.yspeed*this.options.gravityAngleVariance)}a.y+=a.yspeed;a.x+=a.xspeed;a.draw();return false};RainyDay.prototype.positiveMin=function(c,b){var a=0;if(c<b){if(c<=0){a=b}else{a=c}}else{if(b<=0){a=c}else{a=b}}return a<=0?1:a};RainyDay.prototype.REFLECTION_NONE=function(){this.context.fillStyle=this.options.fillStyle;this.context.fill()};RainyDay.prototype.REFLECTION_MINIATURE=function(d){var g=Math.max((d.x-this.options.reflectionDropMappingWidth)/this.options.reflectionScaledownFactor,0);var f=Math.max((d.y-this.options.reflectionDropMappingHeight)/this.options.reflectionScaledownFactor,0);var a=this.positiveMin(this.options.reflectionDropMappingWidth*2/this.options.reflectionScaledownFactor,this.reflected.width-g);var e=this.positiveMin(this.options.reflectionDropMappingHeight*2/this.options.reflectionScaledownFactor,this.reflected.height-f);var c=Math.max(d.x-1.1*d.r,0);var b=Math.max(d.y-1.1*d.r,0);this.context.drawImage(this.reflected,g,f,a,e,c,b,d.r*2,d.r*2)};RainyDay.prototype.COLLISION_SIMPLE=function(b,d){var e=d;var g;while(e!=null){var f=e.drop;if(Math.sqrt(Math.pow(b.x-f.x,2)+Math.pow(b.y-f.y,2))<(b.r+f.r)){g=f;break}e=e.next}if(!g){return}var a,c;if(b.y>g.y){a=b;c=g}else{a=g;c=b}this.clearDrop(c);this.clearDrop(a,true);this.matrix.remove(a);c.draw();c.colliding=a;c.collided=true};RainyDay.prototype.prepareBackground=function(){this.background=document.createElement("canvas");this.background.width=this.canvas.width;this.background.height=this.canvas.height;this.clearbackground=document.createElement("canvas");this.clearbackground.width=this.canvas.width;this.clearbackground.height=this.canvas.height;var a=this.background.getContext("2d");a.clearRect(0,0,this.canvas.width,this.canvas.height);a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.canvas.width,this.canvas.height);a=this.clearbackground.getContext("2d");a.clearRect(0,0,this.canvas.width,this.canvas.height);a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.canvas.width,this.canvas.height);if(!isNaN(this.options.blur)&&this.options.blur>=1){this.stackBlurCanvasRGB(this.canvas.width,this.canvas.height,this.options.blur)}};RainyDay.prototype.stackBlurCanvasRGB=function(a,c,H){var u=[[0,9],[1,11],[2,12],[3,13],[5,14],[7,15],[11,16],[15,17],[22,18],[31,19],[45,20],[63,21],[90,22],[127,23],[181,24]];var G=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];H|=0;var P=this.background.getContext("2d");var L=P.getImageData(0,0,a,c);var e=L.data;var F,E,N,K,m,r,k,M,n,l,D,C,B,d,q,J,j,o,s,w;var g=H+1;var I=g*(g+1)/2;var v=new BlurStack();var h=new BlurStack();var t=v;for(N=1;N<2*H+1;N++){t=t.next=new BlurStack();if(N===g){h=t}}t.next=v;var O=null;var A=null;k=r=0;var z=G[H];var f;for(var b=0;b<u.length;++b){if(H<=u[b][0]){f=u[b-1][1];break}}for(E=0;E<c;E++){d=q=J=M=n=l=0;D=g*(j=e[r]);C=g*(o=e[r+1]);B=g*(s=e[r+2]);M+=I*j;n+=I*o;l+=I*s;t=v;for(N=0;N<g;N++){t.r=j;t.g=o;t.b=s;t=t.next}for(N=1;N<g;N++){K=r+((a-1<N?a-1:N)<<2);M+=(t.r=(j=e[K]))*(w=g-N);n+=(t.g=(o=e[K+1]))*w;l+=(t.b=(s=e[K+2]))*w;d+=j;q+=o;J+=s;t=t.next}O=v;A=h;for(F=0;F<a;F++){e[r]=(M*z)>>f;e[r+1]=(n*z)>>f;e[r+2]=(l*z)>>f;M-=D;n-=C;l-=B;D-=O.r;C-=O.g;B-=O.b;K=(k+((K=F+H+1)<(a-1)?K:(a-1)))<<2;d+=(O.r=e[K]);q+=(O.g=e[K+1]);J+=(O.b=e[K+2]);M+=d;n+=q;l+=J;O=O.next;D+=(j=A.r);C+=(o=A.g);B+=(s=A.b);d-=j;q-=o;J-=s;A=A.next;r+=4}k+=a}for(F=0;F<a;F++){q=J=d=n=l=M=0;r=F<<2;D=g*(j=e[r]);C=g*(o=e[r+1]);B=g*(s=e[r+2]);M+=I*j;n+=I*o;l+=I*s;t=v;for(N=0;N<g;N++){t.r=j;t.g=o;t.b=s;t=t.next}m=a;for(N=1;N<g;N++){r=(m+F)<<2;M+=(t.r=(j=e[r]))*(w=g-N);n+=(t.g=(o=e[r+1]))*w;l+=(t.b=(s=e[r+2]))*w;d+=j;q+=o;J+=s;t=t.next;if(N<(c-1)){m+=a}}r=F;O=v;A=h;for(E=0;E<c;E++){K=r<<2;e[K]=(M*z)>>f;e[K+1]=(n*z)>>f;e[K+2]=(l*z)>>f;M-=D;n-=C;l-=B;D-=O.r;C-=O.g;B-=O.b;K=(F+(((K=E+g)<(c-1)?K:(c-1))*a))<<2;M+=(d+=(O.r=e[K]));n+=(q+=(O.g=e[K+1]));l+=(J+=(O.b=e[K+2]));O=O.next;D+=(j=A.r);C+=(o=A.g);B+=(s=A.b);d-=j;q-=o;J-=s;A=A.next;r+=a}}P.putImageData(L,0,0)};function BlurStack(){this.r=0;this.g=0;this.b=0;this.next=null}function CollisionMatrix(a,e,d){this.resolution=d;this.xc=a;this.yc=e;this.matrix=new Array(a);for(var c=0;c<=(a+5);c++){this.matrix[c]=new Array(e);for(var b=0;b<=(e+5);++b){this.matrix[c][b]=new DropItem(null)}}}CollisionMatrix.prototype.update=function(b,a){if(b.gid){if(!this.matrix[b.gmx]||!this.matrix[b.gmx][b.gmy]){return null}this.matrix[b.gmx][b.gmy].remove(b);if(a){return null}b.gmx=Math.floor(b.x/this.resolution);b.gmy=Math.floor(b.y/this.resolution);if(!this.matrix[b.gmx]||!this.matrix[b.gmx][b.gmy]){return null}this.matrix[b.gmx][b.gmy].add(b);var c=this.collisions(b);if(c&&c.next!=null){return c.next}}else{b.gid=Math.random().toString(36).substr(2,9);b.gmx=Math.floor(b.x/this.resolution);b.gmy=Math.floor(b.y/this.resolution);if(!this.matrix[b.gmx]||!this.matrix[b.gmx][b.gmy]){return null}this.matrix[b.gmx][b.gmy].add(b)}return null};CollisionMatrix.prototype.collisions=function(a){var b=new DropItem(null);var c=b;b=this.addAll(b,a.gmx-1,a.gmy+1);b=this.addAll(b,a.gmx,a.gmy+1);b=this.addAll(b,a.gmx+1,a.gmy+1);return c};CollisionMatrix.prototype.addAll=function(d,a,c){if(a>0&&c>0&&a<this.xc&&c<this.yc){var b=this.matrix[a][c];while(b.next!=null){b=b.next;d.next=new DropItem(b.drop);d=d.next}}return d};CollisionMatrix.prototype.remove=function(a){this.matrix[a.gmx][a.gmy].remove(a)};function DropItem(a){this.drop=a;this.next=null}DropItem.prototype.add=function(a){var b=this;while(b.next!=null){b=b.next}b.next=new DropItem(a)};DropItem.prototype.remove=function(b){var c=this;var a=null;while(c.next!=null){a=c;c=c.next;if(c.drop.gid===b.gid){a.next=c.next}}};